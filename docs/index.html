---

title: espiownage


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Ownage (domination) of ESPI image inference. (Pronounced like "espionage" but with a little "own" in the middle.)</p>
</blockquote>
<p>Welcome to the new phase of <a href="https://github.com/drscotthawley/SPNet">SPNet</a> developement -- IN PROGRESS.<br>
In this incarnation, we'll be making it an image-segmentation code instead of an object detector, and we'll use <a href="fast.ai">fast.ai</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Preliminaries">Preliminaries<a class="anchor-link" href="#Preliminaries"> </a></h3><p>Ubuntu (&amp; probably other Linuxes):</p>
<div class="highlight"><pre><span></span>sudo apt-get install python3-tk
</pre></div>
<p>Mac (with <a href="https://brew.sh/">Homebrew</a>)</p>
<div class="highlight"><pre><span></span>brew install python-tk
</pre></div>
<p>Then on all systems, let's set up a virtual environment called <code>espi</code>. 
I like to put my environments in <code>~/envs</code>:</p>

<pre><code>mkdir ~/envs; python3 -m venv ~/envs/espi; source ~/envs/espi/bin/activate</code></pre>
<p>And then you want/need to update <code>pip</code> in case it gave you an ancient version:</p>
<div class="highlight"><pre><span></span>python3 -m pip install pip --upgrade
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pip-install">Pip install<a class="anchor-link" href="#Pip-install"> </a></h3><div class="highlight"><pre><span></span>pip install espiownage
</pre></div>
<p>Note: the requirements on this package follow a "kitchen sink" approach so that everything a student might need gets installed, e.g. <code>jupyter</code> and more. (And <code>wheel</code> because it speeds up the installations...I think.)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you're reading this, you probably have access to the "real" data, which sits (on my machine) in <code>~/Dropbox/Data/espiownage-data</code>.  So <code>cd</code> to that directory, i.e.,</p>

<pre><code>$ cd ~/Dropbox/Data/espiownage-data</code></pre>
<p>...(or whereever you've got it) for what follows.</p>
<p><strong>AND THEN</strong>, so we don't "clobber" each other's work, make <em>your own copy</em> (~17MB) of the main <code>annotations</code> directory, as in append your last name (hawley, morrison, morgan, etc):</p>
<div class="highlight"><pre><span></span>cp -r annotations annotations_yourlastname
</pre></div>
<p>and then we'll each edit our own copy just to avoid...confusion.</p>
<blockquote><p><em>Note:If you don't have access to the real data,</em> you can still grab the <a href="https://zenodo.org/record/4445434">fake SPNet data</a> and then, for each of those datasets: Move (or symlink) all the images to a directory called <code>images/</code>, and all the <code>.csv</code> files to a directory called <code>annotations/</code>, and proceed.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Console-Scripts:">Console Scripts:<a class="anchor-link" href="#Console-Scripts:"> </a></h2><p>These can all be run from the command line / terminal:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ellipse_editor">ellipse_editor<a class="anchor-link" href="#ellipse_editor"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ellipse_editor" class="doc_header"><code>ellipse_editor</code><a href="https://github.com/drscotthawley/espiownage/tree/master/espiownage/ellipse_editor.py#L404" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ellipse_editor</code>(<strong><code>files</code></strong>:"Wildcard name for all CSV files to edit"=<em>`'annotations/</em>.csv'<code>*, **</code>imgbank<code>**:"Directory where all the (unlabeled) images are"=*</code>'images/'`*)</p>
</blockquote>
<p><strong>Parameters:</strong></p>
<ul>
<li><p><strong><code>files</code></strong> : <em><code>str &lt;Wildcard name for all CSV files to edit&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>imgbank</code></strong> : <em><code>str &lt;Directory where all the (unlabeled) images are&gt;</code></em>, <em>optional</em></p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ellipse_editor -h
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>usage: ellipse_editor [-h] [--files FILES] [--imgbank IMGBANK]

optional arguments:
  -h, --help         show this help message and exit
  --files FILES      Wildcard name for all CSV files to edit (default:
                     annotations/*.csv)
  --imgbank IMGBANK  Directory where all the (unlabeled) images are (default:
                     images/)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Examples:</strong></p>
<div class="highlight"><pre><span></span>ellipse_editor --files<span class="o">=</span>annotations_yourlastname/*.csv
</pre></div>
<p>See <code>ellipse_editor -h</code> for command-line options.   You can, for example, edit only one strike's worth of data by running</p>
<div class="highlight"><pre><span></span>ellipse_editor --files<span class="o">=</span>annotations_yourlastname/06241902*.csv
</pre></div>
<p>or a range of annotations, as in <code>ellipse editor --files=annotations_yourlastname/06241902_proc_001*.csv</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="gen_masks">gen_masks<a class="anchor-link" href="#gen_masks"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gen_masks" class="doc_header"><code>gen_masks</code><a href="https://github.com/drscotthawley/espiownage/tree/master/espiownage/gen_masks.py#L70" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gen_masks</code>(<strong><code>allone</code></strong>:"All objects get assigned to class 1", <strong><code>cp_ann_imgs</code></strong>:"make directory of only images for which annotations exist (to annotated_images/)", <strong><code>files</code></strong>:"Wildcard name for all CSV files to edit"=<em>`'annotations/</em>.csv'<code>*, **</code>maskdir<code>**:"Directory to write segmentation masks to"=*</code>'masks/'<code>*, **</code>step<code>**:"Step size / resolution / precision of ring count"=*</code>1`*)</p>
</blockquote>
<p>Generate segmentation masks for all annotations</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><p><strong><code>allone</code></strong> : <em><code>&lt;All objects get assigned to class 1&gt;</code></em></p>
</li>
<li><p><strong><code>cp_ann_imgs</code></strong> : <em><code>&lt;make directory of only images for which annotations exist (to annotated_images/)&gt;</code></em></p>
</li>
<li><p><strong><code>files</code></strong> : <em><code>str &lt;Wildcard name for all CSV files to edit&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>maskdir</code></strong> : <em><code>str &lt;Directory to write segmentation masks to&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>step</code></strong> : <em><code>float &lt;Step size / resolution / precision of ring count&gt;</code></em>, <em>optional</em></p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>gen_masks -h
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>usage: gen_masks [-h] [--allone] [--cp_ann_imgs] [--files FILES]
                 [--maskdir MASKDIR] [--step STEP]

Generate segmentation masks for all annotations

optional arguments:
  -h, --help         show this help message and exit
  --allone           All objects get assigned to class 1 (default: False)
  --cp_ann_imgs      make directory of only images for which annotations exist
                     (to annotated_images/) (default: False)
  --files FILES      Wildcard name for all CSV files to edit (default:
                     annotations/*.csv)
  --maskdir MASKDIR  Directory to write segmentation masks to (default: masks/)
  --step STEP        Step size / resolution / precision of ring count (default:
                     1)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="gen_bboxes">gen_bboxes<a class="anchor-link" href="#gen_bboxes"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gen_bboxes" class="doc_header"><code>gen_bboxes</code><a href="https://github.com/drscotthawley/espiownage/tree/master/espiownage/gen_bboxes.py#L116" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gen_bboxes</code>(<strong><code>reg</code></strong>:"Set this for regression model (1 class, no steps)", <strong><code>files</code></strong>:"Wildcard name for all (ellipse) CSV files to read"=<em>`'annotations/</em>.csv'<code>*, **</code>bboxdir<code>**:"Directory to write bboxes to"=*</code>'bboxes'<code>*, **</code>step<code>**:"For classification model: Step size / resolution / precision of ring count"=*</code>0.5`*)</p>
</blockquote>
<p><strong>Parameters:</strong></p>
<ul>
<li><p><strong><code>reg</code></strong> : <em><code>&lt;Set this for regression model (1 class, no steps)&gt;</code></em></p>
</li>
<li><p><strong><code>files</code></strong> : <em><code>str &lt;Wildcard name for all (ellipse) CSV files to read&gt;</code></em>, <em>optional</em>    <p>obpr:Param("Set this for one box per ring", store_true),</p></p>
</li>
</ul>
<ul>
<li><p><strong><code>bboxdir</code></strong> : <em><code>str &lt;Directory to write bboxes to&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>step</code></strong> : <em><code>float &lt;For classification model: Step size / resolution / precision of ring count&gt;</code></em>, <em>optional</em></p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>gen_bboxes -h
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>usage: gen_bboxes [-h] [--reg] [--files FILES] [--bboxdir BBOXDIR] [--step STEP]

optional arguments:
  -h, --help         show this help message and exit
  --reg              Set this for regression model (1 class, no steps) (default:
                     False)
  --files FILES      Wildcard name for all (ellipse) CSV files to read (default:
                     annotations/*.csv)
  --bboxdir BBOXDIR  Directory to write bboxes to (default: bboxes)
  --step STEP        For classification model: Step size / resolution /
                     precision of ring count (default: 0.5)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="gen_crops">gen_crops<a class="anchor-link" href="#gen_crops"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gen_crops" class="doc_header"><code>gen_crops</code><a href="https://github.com/drscotthawley/espiownage/tree/master/espiownage/gen_crops.py#L47" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gen_crops</code>(<strong><code>files</code></strong>:"Wildcard name for all CSV files to edit"=<em>`'annotations/</em>.csv'<code>*, **</code>outdir<code>**:"Directory to write output cropped images to"=*</code>'crops/'`*)</p>
</blockquote>
<p>Generate cropped images for all annotations</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><p><strong><code>files</code></strong> : <em><code>str &lt;Wildcard name for all CSV files to edit&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>outdir</code></strong> : <em><code>str &lt;Directory to write output cropped images to&gt;</code></em>, <em>optional</em></p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>gen_crops -h
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>usage: gen_crops [-h] [--files FILES] [--outdir OUTDIR]

Generate cropped images for all annotations

optional arguments:
  -h, --help       show this help message and exit
  --files FILES    Wildcard name for all CSV files to edit (default:
                   annotations/*.csv)
  --outdir OUTDIR  Directory to write output cropped images to (default: crops/)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="grab_recent">grab_recent<a class="anchor-link" href="#grab_recent"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="grab_recent" class="doc_header"><code>grab_recent</code><a href="https://github.com/drscotthawley/espiownage/tree/master/espiownage/grab_recent.py#L18" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>grab_recent</code>(<strong><code>dirs</code></strong>:"annotation directories check"=<em>`'annotations</em>'<code>*, **</code>dest<code>**:"Directory to write new annotations to"=*</code>'recent_annotations'`*)</p>
</blockquote>
<p><strong>Parameters:</strong></p>
<ul>
<li><p><strong><code>dirs</code></strong> : <em><code>str &lt;annotation directories check&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>dest</code></strong> : <em><code>str &lt;Directory to write new annotations to&gt;</code></em>, <em>optional</em></p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>grab_recent -h
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>usage: grab_recent [-h] [--dirs DIRS] [--dest DEST]

optional arguments:
  -h, --help   show this help message and exit
  --dirs DIRS  annotation directories check (default: annotations*)
  --dest DEST  Directory to write new annotations to (default:
               recent_annotations)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="gen_fake">gen_fake<a class="anchor-link" href="#gen_fake"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gen_fake" class="doc_header"><code>gen_fake</code><a href="https://github.com/drscotthawley/espiownage/tree/master/espiownage/gen_fake.py#L265" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gen_fake</code>(<strong><code>n</code></strong>:"Number of images to generate"=<em><code>2000</code></em>, <strong><code>outdir</code></strong>:"Directory to write to"=<em><code>'espiownage-fake'</code></em>)</p>
</blockquote>
<p>Generates fake ESPI-like images</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><p><strong><code>n</code></strong> : <em><code>int &lt;Number of images to generate&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>outdir</code></strong> : <em><code>str &lt;Directory to write to&gt;</code></em>, <em>optional</em></p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>gen_fake -h
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>usage: gen_fake [-h] [--n N] [--outdir OUTDIR]

Generates fake ESPI-like images

optional arguments:
  -h, --help       show this help message and exit
  --n N            Number of images to generate (default: 2000)
  --outdir OUTDIR  Directory to write to (default: espiownage-fake)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Contributing-/-Development">Contributing / Development<a class="anchor-link" href="#Contributing-/-Development"> </a></h2><p>You'll want to install more things:</p>
<div class="highlight"><pre><span></span>pip install nbdev twine
</pre></div>
<p>Fork this repo.  When you want to update your repo, one macro does it all (see <code>Makefile</code>):</p>
<div class="highlight"><pre><span></span>make git_update
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Asides">Asides<a class="anchor-link" href="#Asides"> </a></h2><h3 id="Handy-tips-for-students">Handy tips for students<a class="anchor-link" href="#Handy-tips-for-students"> </a></h3><p>I can never remember how to start up virtual environments / or I don't <em>want</em> to remember. So in my <code>~/.bashrc</code> file (you may have a <code>~/.zshrc</code>) I put in a line where I define an alias/function I call <code>gimme</code>, that reads like so:</p>
<div class="highlight"><pre><span></span>gimme<span class="o">()</span> <span class="o">{</span> <span class="nb">source</span> ~/envs/<span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>/bin/activate<span class="p">;</span>  <span class="o">}</span>
</pre></div>
<p>(note that in order for this alias to be recognized, you need to either logout and log back in or else run <code>$ source ~/.bashrc</code>)</p>
<p>Then when I want to load environment like <code>espi</code> I just type...</p>
<div class="highlight"><pre><span></span>gimme espi
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>--Scott H. Hawley, September 2021</p>

</div>
</div>
</div>
</div>
 

