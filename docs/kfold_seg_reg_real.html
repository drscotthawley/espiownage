---

title: Segmentation Regression - Real data


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/kfold_seg_reg_real.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/kfold_seg_reg_real.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Acknowledgement: I took <a href="https://walkwithfastai.com/Segmentation">Zach Mueller's Image Segmentation tutoral notebook</a> (based on the main FastAI lesson notebook) and modified it to do regression (as per Zach's suggestions) and to work with my own data.</em></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install -Uqq fastai espiownage mrspuff typing_extensions -q --upgrade
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">espiownage</span>
<span class="kn">from</span> <span class="nn">espiownage.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">sysinfo</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;espiownage version </span><span class="si">{</span><span class="n">espiownage</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>TORCH_VERSION=torch1.9.0; CUDA_VERSION=cu111
CUDA available = True, Device count = 1, Current device = 0
Device name = GeForce RTX 3080
hostname: bengio
espiownage version 0.0.41
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">fastcore.xtras</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">fastai.callback.hook</span> <span class="kn">import</span> <span class="n">summary</span>
<span class="kn">from</span> <span class="nn">fastai.callback.progress</span> <span class="kn">import</span> <span class="n">ProgressCallback</span>
<span class="kn">from</span> <span class="nn">fastai.callback.schedule</span> <span class="kn">import</span> <span class="n">lr_find</span><span class="p">,</span> <span class="n">fit_flat_cos</span>

<span class="kn">from</span> <span class="nn">fastai.data.block</span> <span class="kn">import</span> <span class="n">DataBlock</span>
<span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="n">untar_data</span><span class="p">,</span> <span class="n">URLs</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_image_files</span><span class="p">,</span> <span class="n">FuncSplitter</span><span class="p">,</span> <span class="n">Normalize</span>

<span class="kn">from</span> <span class="nn">fastai.layers</span> <span class="kn">import</span> <span class="n">Mish</span>   <span class="c1"># MishJIT gives me trouble :-( </span>
<span class="kn">from</span> <span class="nn">fastai.losses</span> <span class="kn">import</span> <span class="n">BaseLoss</span><span class="p">,</span> <span class="n">MSELossFlat</span><span class="p">,</span> <span class="n">CrossEntropyLossFlat</span><span class="p">,</span> <span class="n">BCEWithLogitsLossFlat</span>
<span class="kn">from</span> <span class="nn">fastai.optimizer</span> <span class="kn">import</span> <span class="n">ranger</span>

<span class="kn">from</span> <span class="nn">fastai.torch_core</span> <span class="kn">import</span> <span class="n">tensor</span>

<span class="kn">from</span> <span class="nn">fastai.vision.augment</span> <span class="kn">import</span> <span class="n">aug_transforms</span>
<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">PILImage</span><span class="p">,</span> <span class="n">PILMask</span>
<span class="kn">from</span> <span class="nn">fastai.vision.data</span> <span class="kn">import</span> <span class="n">ImageBlock</span><span class="p">,</span> <span class="n">MaskBlock</span><span class="p">,</span> <span class="n">imagenet_stats</span>
<span class="kn">from</span> <span class="nn">fastai.vision.learner</span> <span class="kn">import</span> <span class="n">unet_learner</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torchvision.models.resnet</span> <span class="kn">import</span> <span class="n">resnet34</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">mrspuff.utils</span> <span class="kn">import</span> <span class="n">on_colab</span>
<span class="n">on_colab</span> <span class="o">=</span> <span class="n">on_colab</span><span class="p">()</span>
<span class="k">if</span> <span class="n">on_colab</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="s1">&#39;http://hedges.belmont.edu/~shawley/espiownage-cleaner.tgz&#39;</span><span class="p">)</span> 
<span class="k">else</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/home/shawley/datasets/espiownage-cleaner&#39;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>/home/shawley/datasets/espiownage-cleaner
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bin_size</span> <span class="o">=</span> <span class="mf">0.7</span>  
<span class="n">maskdir</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="p">(</span><span class="s1">&#39;masks_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bin_size</span><span class="p">))</span>

<span class="c1"># We can also generate masks dynamically using `espiownage`&#39;s `gen_masks` script:</span>
<span class="c1">#!gen_masks --quiet --step={bin_size} --maskdir={maskdir} --files={str(path/&#39;annotations&#39;)+&#39;/*.csv&#39;}</span>

<span class="n">path_im</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s1">&#39;images&#39;</span>
<span class="n">path_lbl</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="n">maskdir</span>
 
<span class="n">meta_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;annotations&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/*.csv&#39;</span><span class="p">))</span>
<span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta_to_img_path</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_bank</span><span class="o">=</span><span class="n">path_im</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">meta_names</span><span class="p">]</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
<span class="n">lbl_names</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path_lbl</span><span class="p">)</span>

<span class="c1">#sanity check:</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lengths of input lists (should be the same?):&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">meta_names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbl_names</span><span class="p">))</span>

<span class="n">get_msk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">path</span><span class="o">/</span><span class="n">maskdir</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">_P</span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="n">colors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="o">/</span><span class="n">bin_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;colors = &quot;</span><span class="p">,</span><span class="n">colors</span><span class="p">)</span>

<span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">))];</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;codes = &quot;</span><span class="p">,</span><span class="n">codes</span><span class="p">)</span>

<span class="n">yrange</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">);</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;yrange = &quot;</span><span class="p">,</span><span class="n">yrange</span><span class="p">)</span>

<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">384</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">half</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sz</span><span class="p">);</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;half = &quot;</span><span class="p">,</span><span class="n">half</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>lengths of input lists (should be the same?): 1955 1955 1955
colors =  [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
codes =  [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;10&#39;, &#39;11&#39;, &#39;12&#39;, &#39;13&#39;, &#39;14&#39;, &#39;15&#39;]
yrange =  16
half =  (192, 256)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sr_acc_old</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>          <span class="c1"># scores both voids and objects</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">inp</span><span class="o">-</span><span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 

<span class="k">def</span> <span class="nf">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s2">&quot;segmentation regression accuracy: Are we within +/- bin_size?  tries to score only objects, not voids&quot;</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  
    <span class="n">inp</span><span class="p">,</span><span class="n">targ</span> <span class="o">=</span> <span class="n">flatten_check</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span><span class="n">targ</span><span class="p">)</span> <span class="c1"># https://docs.fast.ai/metrics.html#flatten_check</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">targ</span> <span class="o">!=</span> <span class="n">void_code</span>  <span class="c1"># non_voids</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targ</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Empty image (all void)</span>
        <span class="n">where_correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span><span class="o">-</span><span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">bin_size</span>              <span class="c1"># gonna be ~100%!</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">where_correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">-</span><span class="n">targ</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">bin_size</span>  <span class="c1"># don&#39;t count voids in metric</span>
    <span class="k">return</span> <span class="n">where_correct</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">sr_acc05</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="k">return</span> <span class="n">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sr_acc07</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="k">return</span> <span class="n">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sr_acc1</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>  <span class="k">return</span> <span class="n">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sr_acc15</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="k">return</span> <span class="n">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sr_acc2</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>  <span class="k">return</span> <span class="n">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install wandb -qqq
<span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">from</span> <span class="nn">fastai.callback.wandb</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre><span class="ansi-blue-intense-fg ansi-bold">wandb</span>: <span class="ansi-yellow-fg">WARNING</span> Calling wandb.login() after wandb.init() has no effect.
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">kfold</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># set k = 0 to 4  &amp; re-run everything from here down</span>
<span class="n">nk</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">nv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span><span class="o">/</span><span class="n">nk</span><span class="p">)</span> <span class="c1"># size of val set</span>
<span class="n">bgn</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">nv</span>                   <span class="c1"># ind to start val set</span>
<span class="n">inds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">bgn</span><span class="p">,</span> <span class="n">bgn</span><span class="o">+</span><span class="n">nv</span><span class="p">))</span> <span class="c1"># indices for this val set</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span> <span class="n">MaskBlock</span><span class="p">(</span><span class="n">codes</span><span class="p">)),</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">get_msk</span><span class="p">,</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">aug_transforms</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">half</span><span class="p">,</span> <span class="n">flip_vert</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="o">*</span><span class="n">imagenet_stats</span><span class="p">)])</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="n">fnames</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dls</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">codes</span>
<span class="n">name2id</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codes</span><span class="p">)}</span>
<span class="n">void_code</span> <span class="o">=</span> <span class="n">name2id</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">ranger</span>

<span class="n">hrfac</span> <span class="o">=</span> <span class="mf">1.2</span>  <span class="c1"># &#39;headroom factor&#39;</span>
<span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span><span class="o">*</span><span class="n">hrfac</span><span class="p">))</span>  <span class="c1"># balance between &quot;clamping&quot; to range of real data vs too much &quot;compression&quot; from sigmoid nonlineari</span>

<span class="c1">#learn = unet_learner(dls, resnet34, yrange=len(codes), loss_func=MSELossFlat(), metrics=acc_camvid, self_attention=True, act_cls=Mish, opt_func=opt)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">mae</span><span class="p">,</span> <span class="n">sr_acc_old</span><span class="p">,</span> <span class="n">sr_acc05</span><span class="p">,</span> <span class="n">sr_acc07</span><span class="p">,</span> <span class="n">sr_acc1</span><span class="p">,</span> <span class="n">sr_acc15</span><span class="p">,</span> <span class="n">sr_acc2</span><span class="p">]</span>

<span class="c1"># run parameters</span>
<span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mf">1e-3</span>

<span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">&#39;segreg_kfold&#39;</span><span class="p">)</span> <span class="c1"># &lt;-- let wandb make up names  #name=f&quot;k={k},e{epochs},lr{lr}&quot;)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">unet_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet34</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">MSELossFlat</span><span class="p">(),</span> 
                     <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">self_attention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">act_cls</span><span class="o">=</span><span class="n">Mish</span><span class="p">,</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                     <span class="n">cbs</span><span class="o">=</span><span class="n">WandbCallback</span><span class="p">())</span>

<span class="c1">#lr = learn.lr_find().valley</span>
<span class="c1">#print(&quot;Suggested Learning Rate =&quot;,lr)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----- HALF SIZE TRAINING&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training: frozen epochs...&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>  <span class="c1"># these frozen epochs don&#39;t yield much improvement btw</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unfreezing model, lowering lr by 4&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">lrs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lr</span><span class="o">/</span><span class="mi">400</span><span class="p">,</span> <span class="n">lr</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training: unfrozen epochs...&quot;</span><span class="p">)</span>

<span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">lrs</span><span class="p">)</span>

<span class="n">halfweights</span> <span class="o">=</span> <span class="s1">&#39;seg_reg_real_half&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving model: </span><span class="si">{</span><span class="n">halfweights</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">halfweights</span><span class="p">)</span>
<span class="c1">#  Nope we&#39;re not finished! Save wandb.finish() until after Full size training.</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">----- FULL SIZE TRAINING -----&quot;</span><span class="p">)</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span> <span class="n">MaskBlock</span><span class="p">(</span><span class="n">codes</span><span class="p">)),</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">get_msk</span><span class="p">,</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">aug_transforms</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">sz</span><span class="p">,</span> <span class="n">flip_vert</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="o">*</span><span class="n">imagenet_stats</span><span class="p">)])</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="n">fnames</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># smaller batch size because we&#39;re now full size</span>
<span class="n">dls</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">codes</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">unet_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet34</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">MSELossFlat</span><span class="p">(),</span> 
                     <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">self_attention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">act_cls</span><span class="o">=</span><span class="n">Mish</span><span class="p">,</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                     <span class="n">cbs</span><span class="o">=</span><span class="n">WandbCallback</span><span class="p">())</span>
<span class="n">learn</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">halfweights</span><span class="p">)</span>

<span class="c1">#learn.lr_find(end_lr=5e-3)</span>

<span class="n">lr</span> <span class="o">=</span> <span class="mf">3e-4</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training: frozen epochs...&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unfreezing model, lowering lr by...stuff&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">lrs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="n">lr</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span> <span class="n">lrs</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training: unfrozen epochs...&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">lrs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finishing WandB&quot;</span><span class="p">)</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

<span class="n">fullweights</span> <span class="o">=</span> <span class="s1">&#39;seg_reg_real_full&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving model: </span><span class="si">{</span><span class="n">fullweights</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fullweights</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
Finishing last run (ID:2k65c6y3) before initializing another...
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<br/>Waiting for W&B process to finish, PID 909065<br/>Program ended successfully.
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>wandb: ERROR Error while calling W&amp;B API: Error 1062: Duplicate entry &#39;465532-2k65c6y3&#39; for key &#39;PRIMARY&#39; (&lt;Response [409]&gt;)
wandb: ERROR Error while calling W&amp;B API: Error 1062: Duplicate entry &#39;465532-2k65c6y3&#39; for key &#39;PRIMARY&#39; (&lt;Response [409]&gt;)
wandb: ERROR Error while calling W&amp;B API: Error 1062: Duplicate entry &#39;465532-2k65c6y3&#39; for key &#39;PRIMARY&#39; (&lt;Response [409]&gt;)
<span class="ansi-blue-intense-fg ansi-bold">wandb</span>: <span class="ansi-green-fg ansi-red-bg">ERROR</span> Control-C detected -- Run data was not synced
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
...Successfully finished last run (ID:2k65c6y3). Initializing new run:<br/><br/>
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

                Tracking run with wandb version 0.12.2<br/>
                Syncing run <strong style="color:#cdcd00">decent-water-4</strong> to <a href="https://wandb.ai" target="_blank">Weights & Biases</a> <a href="https://docs.wandb.com/integrations/jupyter.html" target="_blank">(Documentation)</a>.<br/>
                Project page: <a href="https://wandb.ai/drscotthawley/segreg_kfold" target="_blank">https://wandb.ai/drscotthawley/segreg_kfold</a><br/>
                Run page: <a href="https://wandb.ai/drscotthawley/segreg_kfold/runs/1q664sgr" target="_blank">https://wandb.ai/drscotthawley/segreg_kfold/runs/1q664sgr</a><br/>
                Run data is saved locally in <code>/home/shawley/espi-work/wandb/run-20210923_165128-1q664sgr</code><br/><br/>
            
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>----- HALF SIZE TRAINING
Training: frozen epochs...
WandbCallback requires use of &#34;SaveModelCallback&#34; to log best model
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='0' class='' max='12' style='width:300px; height:20px; vertical-align: middle;'></progress>
      0.00% [0/12 00:00<00:00]
    </div>
    
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>mae</th>
      <th>sr_acc_old</th>
      <th>sr_acc05</th>
      <th>sr_acc07</th>
      <th>sr_acc1</th>
      <th>sr_acc15</th>
      <th>sr_acc2</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table><p>

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='40' class='' max='391' style='width:300px; height:20px; vertical-align: middle;'></progress>
      10.23% [40/391 00:03<00:29 16.2600]
    </div>
    
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>wandb: ERROR Error while calling W&amp;B API: Error 1062: Duplicate entry &#39;465532-2k65c6y3&#39; for key &#39;PRIMARY&#39; (&lt;Response [409]&gt;)
Process wandb_internal:
Traceback (most recent call last):
  File &#34;/usr/lib/python3.8/multiprocessing/process.py&#34;, line 315, in _bootstrap
    self.run()
  File &#34;/usr/lib/python3.8/multiprocessing/process.py&#34;, line 108, in run
    self._target(*self._args, **self._kwargs)
  File &#34;/home/shawley/.local/lib/python3.8/site-packages/wandb/sdk/internal/internal.py&#34;, line 152, in wandb_internal
    thread.join()
  File &#34;/usr/lib/python3.8/threading.py&#34;, line 1011, in join
    self._wait_for_tstate_lock()
  File &#34;/usr/lib/python3.8/threading.py&#34;, line 1027, in _wait_for_tstate_lock
    elif lock.acquire(block, timeout):
KeyboardInterrupt
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipykernel_908805/1013455345.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     22</span> 
<span class="ansi-green-intense-fg ansi-bold">     23</span> print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;Training: frozen epochs...&#34;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 24</span><span class="ansi-red-fg"> </span>learn<span class="ansi-blue-fg">.</span>fit_flat_cos<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">12</span><span class="ansi-blue-fg">,</span> slice<span class="ansi-blue-fg">(</span>lr<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>  <span class="ansi-red-fg"># these frozen epochs don&#39;t yield much improvement btw</span>
<span class="ansi-green-intense-fg ansi-bold">     25</span> 
<span class="ansi-green-intense-fg ansi-bold">     26</span> print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;unfreezing model, lowering lr by 4&#34;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/callback/schedule.py</span> in <span class="ansi-cyan-fg">fit_flat_cos</span><span class="ansi-blue-fg">(self, n_epoch, lr, div_final, pct_start, wd, cbs, reset_opt)</span>
<span class="ansi-green-intense-fg ansi-bold">    134</span>     lr <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>array<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span>h<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;lr&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-green-fg">for</span> h <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">.</span>hypers<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    135</span>     scheds <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">{</span><span class="ansi-blue-fg">&#39;lr&#39;</span><span class="ansi-blue-fg">:</span> combined_cos<span class="ansi-blue-fg">(</span>pct_start<span class="ansi-blue-fg">,</span> lr<span class="ansi-blue-fg">,</span> lr<span class="ansi-blue-fg">,</span> lr<span class="ansi-blue-fg">/</span>div_final<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">}</span>
<span class="ansi-green-fg">--&gt; 136</span><span class="ansi-red-fg">     </span>self<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>n_epoch<span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">=</span>ParamScheduler<span class="ansi-blue-fg">(</span>scheds<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">+</span>L<span class="ansi-blue-fg">(</span>cbs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> reset_opt<span class="ansi-blue-fg">=</span>reset_opt<span class="ansi-blue-fg">,</span> wd<span class="ansi-blue-fg">=</span>wd<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    137</span> 
<span class="ansi-green-intense-fg ansi-bold">    138</span> <span class="ansi-red-fg"># Cell</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/learner.py</span> in <span class="ansi-cyan-fg">fit</span><span class="ansi-blue-fg">(self, n_epoch, lr, wd, cbs, reset_opt)</span>
<span class="ansi-green-intense-fg ansi-bold">    219</span>             self<span class="ansi-blue-fg">.</span>opt<span class="ansi-blue-fg">.</span>set_hypers<span class="ansi-blue-fg">(</span>lr<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>lr <span class="ansi-green-fg">if</span> lr <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span> <span class="ansi-green-fg">else</span> lr<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    220</span>             self<span class="ansi-blue-fg">.</span>n_epoch <span class="ansi-blue-fg">=</span> n_epoch
<span class="ansi-green-fg">--&gt; 221</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_do_fit<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;fit&#39;</span><span class="ansi-blue-fg">,</span> CancelFitException<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>_end_cleanup<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    222</span> 
<span class="ansi-green-intense-fg ansi-bold">    223</span>     <span class="ansi-green-fg">def</span> _end_cleanup<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>dl<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>xb<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>yb<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>pred<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>loss <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">(</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">(</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/learner.py</span> in <span class="ansi-cyan-fg">_with_events</span><span class="ansi-blue-fg">(self, f, event_type, ex, final)</span>
<span class="ansi-green-intense-fg ansi-bold">    161</span> 
<span class="ansi-green-intense-fg ansi-bold">    162</span>     <span class="ansi-green-fg">def</span> _with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> f<span class="ansi-blue-fg">,</span> event_type<span class="ansi-blue-fg">,</span> ex<span class="ansi-blue-fg">,</span> final<span class="ansi-blue-fg">=</span>noop<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 163</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;before_{event_type}&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>  f<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    164</span>         <span class="ansi-green-fg">except</span> ex<span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;after_cancel_{event_type}&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    165</span>         self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;after_{event_type}&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>  final<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/learner.py</span> in <span class="ansi-cyan-fg">_do_fit</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    210</span>         <span class="ansi-green-fg">for</span> epoch <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>n_epoch<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    211</span>             self<span class="ansi-blue-fg">.</span>epoch<span class="ansi-blue-fg">=</span>epoch
<span class="ansi-green-fg">--&gt; 212</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>_with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_do_epoch<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;epoch&#39;</span><span class="ansi-blue-fg">,</span> CancelEpochException<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    213</span> 
<span class="ansi-green-intense-fg ansi-bold">    214</span>     <span class="ansi-green-fg">def</span> fit<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> n_epoch<span class="ansi-blue-fg">,</span> lr<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> wd<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> reset_opt<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/learner.py</span> in <span class="ansi-cyan-fg">_with_events</span><span class="ansi-blue-fg">(self, f, event_type, ex, final)</span>
<span class="ansi-green-intense-fg ansi-bold">    161</span> 
<span class="ansi-green-intense-fg ansi-bold">    162</span>     <span class="ansi-green-fg">def</span> _with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> f<span class="ansi-blue-fg">,</span> event_type<span class="ansi-blue-fg">,</span> ex<span class="ansi-blue-fg">,</span> final<span class="ansi-blue-fg">=</span>noop<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 163</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;before_{event_type}&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>  f<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    164</span>         <span class="ansi-green-fg">except</span> ex<span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;after_cancel_{event_type}&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    165</span>         self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;after_{event_type}&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>  final<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/learner.py</span> in <span class="ansi-cyan-fg">_do_epoch</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    204</span> 
<span class="ansi-green-intense-fg ansi-bold">    205</span>     <span class="ansi-green-fg">def</span> _do_epoch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 206</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>_do_epoch_train<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    207</span>         self<span class="ansi-blue-fg">.</span>_do_epoch_validate<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    208</span> 

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/learner.py</span> in <span class="ansi-cyan-fg">_do_epoch_train</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    196</span>     <span class="ansi-green-fg">def</span> _do_epoch_train<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    197</span>         self<span class="ansi-blue-fg">.</span>dl <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dls<span class="ansi-blue-fg">.</span>train
<span class="ansi-green-fg">--&gt; 198</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>_with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>all_batches<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;train&#39;</span><span class="ansi-blue-fg">,</span> CancelTrainException<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    199</span> 
<span class="ansi-green-intense-fg ansi-bold">    200</span>     <span class="ansi-green-fg">def</span> _do_epoch_validate<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> ds_idx<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> dl<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/learner.py</span> in <span class="ansi-cyan-fg">_with_events</span><span class="ansi-blue-fg">(self, f, event_type, ex, final)</span>
<span class="ansi-green-intense-fg ansi-bold">    161</span> 
<span class="ansi-green-intense-fg ansi-bold">    162</span>     <span class="ansi-green-fg">def</span> _with_events<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> f<span class="ansi-blue-fg">,</span> event_type<span class="ansi-blue-fg">,</span> ex<span class="ansi-blue-fg">,</span> final<span class="ansi-blue-fg">=</span>noop<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 163</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;before_{event_type}&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>  f<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    164</span>         <span class="ansi-green-fg">except</span> ex<span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;after_cancel_{event_type}&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    165</span>         self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;after_{event_type}&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>  final<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/learner.py</span> in <span class="ansi-cyan-fg">all_batches</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    167</span>     <span class="ansi-green-fg">def</span> all_batches<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    168</span>         self<span class="ansi-blue-fg">.</span>n_iter <span class="ansi-blue-fg">=</span> len<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dl<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 169</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> enumerate<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dl<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>one_batch<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>o<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    170</span> 
<span class="ansi-green-intense-fg ansi-bold">    171</span>     <span class="ansi-green-fg">def</span> _do_one_batch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/data/load.py</span> in <span class="ansi-cyan-fg">__iter__</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    109</span>         <span class="ansi-green-fg">for</span> b <span class="ansi-green-fg">in</span> _loaders<span class="ansi-blue-fg">[</span>self<span class="ansi-blue-fg">.</span>fake_l<span class="ansi-blue-fg">.</span>num_workers<span class="ansi-blue-fg">==</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>fake_l<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    110</span>             <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>device <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> b <span class="ansi-blue-fg">=</span> to_device<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>device<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 111</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">yield</span> self<span class="ansi-blue-fg">.</span>after_batch<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    112</span>         self<span class="ansi-blue-fg">.</span>after_iter<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    113</span>         <span class="ansi-green-fg">if</span> hasattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;it&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">del</span><span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>it<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastcore/transform.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, o)</span>
<span class="ansi-green-intense-fg ansi-bold">    198</span>         self<span class="ansi-blue-fg">.</span>fs <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>fs<span class="ansi-blue-fg">.</span>sorted<span class="ansi-blue-fg">(</span>key<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;order&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    199</span> 
<span class="ansi-green-fg">--&gt; 200</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">def</span> __call__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> o<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> compose_tfms<span class="ansi-blue-fg">(</span>o<span class="ansi-blue-fg">,</span> tfms<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>fs<span class="ansi-blue-fg">,</span> split_idx<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>split_idx<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    201</span>     <span class="ansi-green-fg">def</span> __repr__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> <span class="ansi-blue-fg">f&#34;Pipeline: {&#39; -&gt; &#39;.join([f.name for f in self.fs if f.name != &#39;noop&#39;])}&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">    202</span>     <span class="ansi-green-fg">def</span> __getitem__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span>i<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>fs<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastcore/transform.py</span> in <span class="ansi-cyan-fg">compose_tfms</span><span class="ansi-blue-fg">(x, tfms, is_enc, reverse, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    148</span>     <span class="ansi-green-fg">for</span> f <span class="ansi-green-fg">in</span> tfms<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    149</span>         <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> is_enc<span class="ansi-blue-fg">:</span> f <span class="ansi-blue-fg">=</span> f<span class="ansi-blue-fg">.</span>decode
<span class="ansi-green-fg">--&gt; 150</span><span class="ansi-red-fg">         </span>x <span class="ansi-blue-fg">=</span> f<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    151</span>     <span class="ansi-green-fg">return</span> x
<span class="ansi-green-intense-fg ansi-bold">    152</span> 

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/vision/augment.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, b, split_idx, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">     32</span> 
<span class="ansi-green-intense-fg ansi-bold">     33</span>     <span class="ansi-green-fg">def</span> __call__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">,</span> split_idx<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 34</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>before_call<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> split_idx<span class="ansi-blue-fg">=</span>split_idx<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     35</span>         <span class="ansi-green-fg">return</span> super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__call__<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> split_idx<span class="ansi-blue-fg">=</span>split_idx<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>do <span class="ansi-green-fg">else</span> b
<span class="ansi-green-intense-fg ansi-bold">     36</span> 

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/vision/augment.py</span> in <span class="ansi-cyan-fg">before_call</span><span class="ansi-blue-fg">(self, b, split_idx)</span>
<span class="ansi-green-intense-fg ansi-bold">    375</span>         <span class="ansi-green-fg">while</span> isinstance<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> tuple<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> b <span class="ansi-blue-fg">=</span> b<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">    376</span>         self<span class="ansi-blue-fg">.</span>split_idx <span class="ansi-blue-fg">=</span> split_idx
<span class="ansi-green-fg">--&gt; 377</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>do<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>mat <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>_get_affine_mat<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    378</span>         <span class="ansi-green-fg">for</span> t <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>coord_fs<span class="ansi-blue-fg">:</span> t<span class="ansi-blue-fg">.</span>before_call<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    379</span> 

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/vision/augment.py</span> in <span class="ansi-cyan-fg">_get_affine_mat</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-intense-fg ansi-bold">    391</span>         ms <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>m <span class="ansi-green-fg">for</span> m <span class="ansi-green-fg">in</span> ms <span class="ansi-green-fg">if</span> m <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">    392</span>         <span class="ansi-green-fg">for</span> m <span class="ansi-green-fg">in</span> ms<span class="ansi-blue-fg">:</span> aff_m <span class="ansi-blue-fg">=</span> aff_m <span class="ansi-blue-fg">@</span> m
<span class="ansi-green-fg">--&gt; 393</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> _prepare_mat<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">,</span> aff_m<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    394</span> 
<span class="ansi-green-intense-fg ansi-bold">    395</span>     <span class="ansi-green-fg">def</span> _encode<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> x<span class="ansi-blue-fg">,</span> mode<span class="ansi-blue-fg">,</span> reverse<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/vision/augment.py</span> in <span class="ansi-cyan-fg">_prepare_mat</span><span class="ansi-blue-fg">(x, mat)</span>
<span class="ansi-green-intense-fg ansi-bold">    358</span>     h<span class="ansi-blue-fg">,</span>w <span class="ansi-blue-fg">=</span> getattr<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;img_size&#39;</span><span class="ansi-blue-fg">,</span> x<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    359</span>     mat<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">*=</span> h<span class="ansi-blue-fg">/</span>w
<span class="ansi-green-fg">--&gt; 360</span><span class="ansi-red-fg">     </span>mat<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">*=</span> w<span class="ansi-blue-fg">/</span>h
<span class="ansi-green-intense-fg ansi-bold">    361</span>     <span class="ansi-green-fg">return</span> mat<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">:</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">    362</span> 

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/fastai/torch_core.py</span> in <span class="ansi-cyan-fg">__torch_function__</span><span class="ansi-blue-fg">(self, func, types, args, kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    338</span>         convert<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span>
<span class="ansi-green-intense-fg ansi-bold">    339</span>         <span class="ansi-green-fg">if</span> _torch_handled<span class="ansi-blue-fg">(</span>args<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>_opt<span class="ansi-blue-fg">,</span> func<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> convert<span class="ansi-blue-fg">,</span>types <span class="ansi-blue-fg">=</span> type<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">(</span>torch<span class="ansi-blue-fg">.</span>Tensor<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 340</span><span class="ansi-red-fg">         </span>res <span class="ansi-blue-fg">=</span> super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__torch_function__<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> types<span class="ansi-blue-fg">,</span> args<span class="ansi-blue-fg">=</span>args<span class="ansi-blue-fg">,</span> kwargs<span class="ansi-blue-fg">=</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    341</span>         <span class="ansi-green-fg">if</span> convert<span class="ansi-blue-fg">:</span> res <span class="ansi-blue-fg">=</span> convert<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    342</span>         <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">,</span> TensorBase<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> res<span class="ansi-blue-fg">.</span>set_meta<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> as_copy<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/.local/lib/python3.8/site-packages/torch/_tensor.py</span> in <span class="ansi-cyan-fg">__torch_function__</span><span class="ansi-blue-fg">(cls, func, types, args, kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">   1021</span> 
<span class="ansi-green-intense-fg ansi-bold">   1022</span>         <span class="ansi-green-fg">with</span> _C<span class="ansi-blue-fg">.</span>DisableTorchFunction<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1023</span><span class="ansi-red-fg">             </span>ret <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1024</span>             <span class="ansi-green-fg">return</span> _convert<span class="ansi-blue-fg">(</span>ret<span class="ansi-blue-fg">,</span> cls<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1025</span> 

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inference">Inference<a class="anchor-link" href="#Inference"> </a></h2><p>this will generate a bunch of images of segmentation masks and a list of filenames of top losses</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fullweights</span><span class="p">)</span>

<span class="n">preds</span><span class="p">,</span> <span class="n">targs</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">with_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># validation set only</span>
<span class="nb">print</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">targs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_tmask</span><span class="p">(</span><span class="n">tmask</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># save tensor mask</span>
    <span class="n">tmask_new</span> <span class="o">=</span> <span class="n">tmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
    <span class="n">use_min</span><span class="p">,</span> <span class="n">use_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span>    <span class="c1"># use scale of max ring count</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span> <span class="n">use_min</span><span class="p">,</span> <span class="n">use_max</span> <span class="o">=</span> <span class="n">tmask_new</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">tmask_new</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>   <span class="c1"># auto scale for just this image</span>
    <span class="n">rescaled</span> <span class="o">=</span> <span class="p">(</span><span class="mf">255.0</span> <span class="o">/</span> <span class="n">use_max</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmask_new</span> <span class="o">-</span> <span class="n">use_min</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rescaled</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fname</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im</span>

<span class="n">seg_img_dir</span> <span class="o">=</span> <span class="s1">&#39;seg_reg_images&#39;</span>
<span class="c1">#!rm -rf {seg_img_dir};  # leave &#39;em</span>
<span class="o">!</span> mkdir <span class="o">{</span>seg_img_dir<span class="o">}</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)):</span>
    <span class="c1">#line_list = [dls.valid.items[i].stem]+[round(targs[i].cpu().numpy().item(),2), round(preds[i][0].cpu().numpy().item(),2), losses[i].cpu().numpy(), i]</span>
    <span class="n">filestem</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">line_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">filestem</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">losses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">save_tmask</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">seg_img_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">filestem</span><span class="o">+</span><span class="s1">&#39;_pred.png&#39;</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span>

<span class="c1"># store as pandas dataframe</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>

<span class="n">res_df</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># top loss order</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;segreg_top_losses_real_k</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;fastai.learner.Learner at 0x7fe9342206d0&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

