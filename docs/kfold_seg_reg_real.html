---

title: Segmentation Regression - Real data


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/kfold_seg_reg_real.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/kfold_seg_reg_real.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Acknowledgement: I took <a href="https://walkwithfastai.com/Segmentation">Zach Mueller's Image Segmentation tutoral notebook</a> (based on the main FastAI lesson notebook) and modified it to do regression (as per Zach's suggestions) and to work with my own data.</em></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install -Uqq fastai espiownage mrspuff typing_extensions -q --upgrade
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">espiownage</span>
<span class="kn">from</span> <span class="nn">espiownage.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">sysinfo</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;espiownage version </span><span class="si">{</span><span class="n">espiownage</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>TORCH_VERSION=torch1.9.0; CUDA_VERSION=cu111
CUDA available = True, Device count = 1, Current device = 0
Device name = GeForce RTX 3080
hostname: bengio
espiownage version 0.0.41
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">espiownage.core</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Below you will find the exact imports for everything we use today</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastcore.xtras</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">fastai.callback.hook</span> <span class="kn">import</span> <span class="n">summary</span>
<span class="kn">from</span> <span class="nn">fastai.callback.progress</span> <span class="kn">import</span> <span class="n">ProgressCallback</span>
<span class="kn">from</span> <span class="nn">fastai.callback.schedule</span> <span class="kn">import</span> <span class="n">lr_find</span><span class="p">,</span> <span class="n">fit_flat_cos</span>

<span class="kn">from</span> <span class="nn">fastai.data.block</span> <span class="kn">import</span> <span class="n">DataBlock</span>
<span class="kn">from</span> <span class="nn">fastai.data.external</span> <span class="kn">import</span> <span class="n">untar_data</span><span class="p">,</span> <span class="n">URLs</span>
<span class="kn">from</span> <span class="nn">fastai.data.transforms</span> <span class="kn">import</span> <span class="n">get_image_files</span><span class="p">,</span> <span class="n">FuncSplitter</span><span class="p">,</span> <span class="n">Normalize</span>

<span class="kn">from</span> <span class="nn">fastai.layers</span> <span class="kn">import</span> <span class="n">Mish</span>   <span class="c1"># MishJIT gives me trouble :-( </span>
<span class="kn">from</span> <span class="nn">fastai.losses</span> <span class="kn">import</span> <span class="n">BaseLoss</span><span class="p">,</span> <span class="n">MSELossFlat</span><span class="p">,</span> <span class="n">CrossEntropyLossFlat</span><span class="p">,</span> <span class="n">BCEWithLogitsLossFlat</span>
<span class="kn">from</span> <span class="nn">fastai.optimizer</span> <span class="kn">import</span> <span class="n">ranger</span>

<span class="kn">from</span> <span class="nn">fastai.torch_core</span> <span class="kn">import</span> <span class="n">tensor</span>

<span class="kn">from</span> <span class="nn">fastai.vision.augment</span> <span class="kn">import</span> <span class="n">aug_transforms</span>
<span class="kn">from</span> <span class="nn">fastai.vision.core</span> <span class="kn">import</span> <span class="n">PILImage</span><span class="p">,</span> <span class="n">PILMask</span>
<span class="kn">from</span> <span class="nn">fastai.vision.data</span> <span class="kn">import</span> <span class="n">ImageBlock</span><span class="p">,</span> <span class="n">MaskBlock</span><span class="p">,</span> <span class="n">imagenet_stats</span>
<span class="kn">from</span> <span class="nn">fastai.vision.learner</span> <span class="kn">import</span> <span class="n">unet_learner</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torchvision.models.resnet</span> <span class="kn">import</span> <span class="n">resnet34</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="kn">from</span> <span class="nn">mrspuff.utils</span> <span class="kn">import</span> <span class="n">on_colab</span>

<span class="n">on_colab</span> <span class="o">=</span> <span class="n">on_colab</span><span class="p">()</span>

<span class="k">if</span> <span class="n">on_colab</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="s1">&#39;http://hedges.belmont.edu/~shawley/espiownage-cleaner.tgz&#39;</span><span class="p">)</span> 
<span class="k">else</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/home/shawley/datasets/espiownage-cleaner&#39;</span><span class="p">)</span> 

<span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>/home/shawley/datasets/espiownage-cleaner
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bin_size</span> <span class="o">=</span> <span class="mf">0.7</span>  
<span class="n">maskdir</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="p">(</span><span class="s1">&#39;masks_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bin_size</span><span class="p">))</span>

<span class="c1"># We can also generate masks dynamically using `espiownage`&#39;s `gen_masks` script:</span>
<span class="c1">#!gen_masks --quiet --step={bin_size} --maskdir={maskdir} --files={str(path/&#39;annotations&#39;)+&#39;/*.csv&#39;}</span>

<span class="n">path_im</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s1">&#39;images&#39;</span>
<span class="n">path_lbl</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="n">maskdir</span>
 
<span class="n">meta_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;annotations&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/*.csv&#39;</span><span class="p">))</span>
<span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta_to_img_path</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">img_bank</span><span class="o">=</span><span class="n">path_im</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">meta_names</span><span class="p">]</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
<span class="n">lbl_names</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path_lbl</span><span class="p">)</span>

<span class="c1">#sanity check:</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lengths of input lists (should be the same?):&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">meta_names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbl_names</span><span class="p">))</span>

<span class="n">get_msk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">path</span><span class="o">/</span><span class="n">maskdir</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">_P</span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="n">colors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="o">/</span><span class="n">bin_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;colors = &quot;</span><span class="p">,</span><span class="n">colors</span><span class="p">)</span>

<span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">))];</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;codes = &quot;</span><span class="p">,</span><span class="n">codes</span><span class="p">)</span>

<span class="n">yrange</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">);</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;yrange = &quot;</span><span class="p">,</span><span class="n">yrange</span><span class="p">)</span>

<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">384</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">half</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sz</span><span class="p">);</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;half = &quot;</span><span class="p">,</span><span class="n">half</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>lengths of input lists (should be the same?): 1955 1955 1955
colors =  [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
codes =  [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;10&#39;, &#39;11&#39;, &#39;12&#39;, &#39;13&#39;, &#39;14&#39;, &#39;15&#39;]
yrange =  16
half =  (192, 256)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sr_acc_old</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>          <span class="c1"># scores both voids and objects</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">inp</span><span class="o">-</span><span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 

<span class="k">def</span> <span class="nf">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s2">&quot;segmentation regression accuracy: Are we within +/- bin_size?  tries to score only objects, not voids&quot;</span>
    <span class="n">targ</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  
    <span class="n">inp</span><span class="p">,</span><span class="n">targ</span> <span class="o">=</span> <span class="n">flatten_check</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span><span class="n">targ</span><span class="p">)</span> <span class="c1"># https://docs.fast.ai/metrics.html#flatten_check</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">targ</span> <span class="o">!=</span> <span class="n">void_code</span>  <span class="c1"># non_voids</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targ</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Empty image (all void)</span>
        <span class="n">where_correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span><span class="o">-</span><span class="n">targ</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">bin_size</span>              <span class="c1"># gonna be ~100%!</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">where_correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">-</span><span class="n">targ</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">bin_size</span>  <span class="c1"># don&#39;t count voids in metric</span>
    <span class="k">return</span> <span class="n">where_correct</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">sr_acc05</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="k">return</span> <span class="n">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">sr_acc1</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="k">return</span> <span class="n">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">sr_acc15</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="k">return</span> <span class="n">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">sr_acc2</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span> <span class="k">return</span> <span class="n">sr_acc</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install wandb -qqq
<span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">from</span> <span class="nn">fastai.callback.wandb</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre><span class="ansi-blue-intense-fg ansi-bold">wandb</span>: Currently logged in as: <span class="ansi-yellow-fg">drscotthawley</span> (use `wandb login --relogin` to force relogin)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">kfold</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># set k = 0 to 4  &amp; re-run everything from here down</span>
<span class="n">nk</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">nv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span><span class="o">/</span><span class="n">nk</span><span class="p">)</span> <span class="c1"># size of val set</span>
<span class="n">bgn</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">nv</span>                   <span class="c1"># ind to start val set</span>
<span class="n">inds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">bgn</span><span class="p">,</span> <span class="n">bgn</span><span class="o">+</span><span class="n">nv</span><span class="p">))</span> <span class="c1"># indices for this val set</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span> <span class="n">MaskBlock</span><span class="p">(</span><span class="n">codes</span><span class="p">)),</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">get_msk</span><span class="p">,</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">aug_transforms</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">half</span><span class="p">,</span> <span class="n">flip_vert</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="o">*</span><span class="n">imagenet_stats</span><span class="p">)])</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="n">fnames</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dls</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">codes</span>
<span class="n">name2id</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codes</span><span class="p">)}</span>
<span class="n">void_code</span> <span class="o">=</span> <span class="n">name2id</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/shawley/.local/lib/python3.8/site-packages/torch/_tensor.py:575: UserWarning: floor_divide is deprecated, and will be removed in a future version of pytorch. It currently rounds toward 0 (like the &#39;trunc&#39; function NOT &#39;floor&#39;). This results in incorrect rounding for negative values.
To keep the current behavior, use torch.div(a, b, rounding_mode=&#39;trunc&#39;), or for actual floor division, use torch.div(a, b, rounding_mode=&#39;floor&#39;). (Triggered internally at  /pytorch/aten/src/ATen/native/BinaryOps.cpp:467.)
  return torch.floor_divide(self, other)
/home/shawley/.local/lib/python3.8/site-packages/torch/_tensor.py:1023: UserWarning: torch.solve is deprecated in favor of torch.linalg.solveand will be removed in a future PyTorch release.
torch.linalg.solve has its arguments reversed and does not return the LU factorization.
To get the LU factorization see torch.lu, which can be used with torch.lu_solve or torch.lu_unpack.
X = torch.solve(B, A).solution
should be replaced with
X = torch.linalg.solve(A, B) (Triggered internally at  /pytorch/aten/src/ATen/native/BatchLinearAlgebra.cpp:760.)
  ret = func(*args, **kwargs)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">ranger</span>

<span class="n">hrfac</span> <span class="o">=</span> <span class="mf">1.2</span>  <span class="c1"># &#39;headroom factor&#39;</span>
<span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span><span class="o">*</span><span class="n">hrfac</span><span class="p">))</span>  <span class="c1"># balance between &quot;clamping&quot; to range of real data vs too much &quot;compression&quot; from sigmoid nonlineari</span>

<span class="c1">#learn = unet_learner(dls, resnet34, yrange=len(codes), loss_func=MSELossFlat(), metrics=acc_camvid, self_attention=True, act_cls=Mish, opt_func=opt)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">mae</span><span class="p">,</span> <span class="n">sr_acc_old</span><span class="p">,</span> <span class="n">sr_acc05</span><span class="p">,</span> <span class="n">sr_acc1</span><span class="p">,</span> <span class="n">sr_acc15</span><span class="p">,</span> <span class="n">sr_acc2</span><span class="p">]</span>

<span class="c1"># run parameters</span>
<span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mf">1e-3</span>

<span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">&#39;segreg_kfold&#39;</span><span class="p">)</span> <span class="c1"># &lt;-- let wandb make up names  #name=f&quot;k={k},e{epochs},lr{lr}&quot;)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">unet_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet34</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">MSELossFlat</span><span class="p">(),</span> 
                     <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">self_attention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">act_cls</span><span class="o">=</span><span class="n">Mish</span><span class="p">,</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                     <span class="n">cbs</span><span class="o">=</span><span class="n">WandbCallback</span><span class="p">())</span>

<span class="c1">#lr = learn.lr_find().valley</span>
<span class="c1">#print(&quot;Suggested Learning Rate =&quot;,lr)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----- HALF SIZE TRAINING&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training: frozen epochs...&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>  <span class="c1"># these frozen epochs don&#39;t yield much improvement btw</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unfreezing model, lowering lr by 4&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">lrs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lr</span><span class="o">/</span><span class="mi">400</span><span class="p">,</span> <span class="n">lr</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training: unfrozen epochs...&quot;</span><span class="p">)</span>

<span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">lrs</span><span class="p">)</span>

<span class="n">halfweights</span> <span class="o">=</span> <span class="s1">&#39;seg_reg_real_half&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving model: </span><span class="si">{</span><span class="n">halfweights</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">halfweights</span><span class="p">)</span>
<span class="c1">#  Nope we&#39;re not finished! wandb.finish()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">----- FULL SIZE TRAINING -----&quot;</span><span class="p">)</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">ImageBlock</span><span class="p">,</span> <span class="n">MaskBlock</span><span class="p">(</span><span class="n">codes</span><span class="p">)),</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_image_files</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">inds</span><span class="p">),</span>
    <span class="n">get_y</span><span class="o">=</span><span class="n">get_msk</span><span class="p">,</span>
    <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">aug_transforms</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">sz</span><span class="p">,</span> <span class="n">flip_vert</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="o">*</span><span class="n">imagenet_stats</span><span class="p">)])</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="n">fnames</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># smaller batch size because we&#39;re now full size</span>
<span class="n">dls</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">codes</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">unet_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">resnet34</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">MSELossFlat</span><span class="p">(),</span> 
                     <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">self_attention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">act_cls</span><span class="o">=</span><span class="n">Mish</span><span class="p">,</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                     <span class="n">cbs</span><span class="o">=</span><span class="n">WandbCallback</span><span class="p">())</span>
<span class="n">learn</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">halfweights</span><span class="p">)</span>

<span class="c1">#learn.lr_find(end_lr=5e-3)</span>

<span class="n">lr</span> <span class="o">=</span> <span class="mf">3e-4</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training: frozen epochs...&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">lr</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unfreezing model, lowering lr by...stuff&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">lrs</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="n">lr</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span> <span class="n">lrs</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training: unfrozen epochs...&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_flat_cos</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">lrs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finishing WandB&quot;</span><span class="p">)</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

<span class="n">fullweights</span> <span class="o">=</span> <span class="s1">&#39;seg_reg_real_full&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving model: </span><span class="si">{</span><span class="n">fullweights</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fullweights</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

                Tracking run with wandb version 0.12.2<br/>
                Syncing run <strong style="color:#cdcd00">good-wildflower-3</strong> to <a href="https://wandb.ai" target="_blank">Weights & Biases</a> <a href="https://docs.wandb.com/integrations/jupyter.html" target="_blank">(Documentation)</a>.<br/>
                Project page: <a href="https://wandb.ai/drscotthawley/segreg_kfold" target="_blank">https://wandb.ai/drscotthawley/segreg_kfold</a><br/>
                Run page: <a href="https://wandb.ai/drscotthawley/segreg_kfold/runs/2k65c6y3" target="_blank">https://wandb.ai/drscotthawley/segreg_kfold/runs/2k65c6y3</a><br/>
                Run data is saved locally in <code>/home/shawley/espi-work/wandb/run-20210923_164301-2k65c6y3</code><br/><br/>
            
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/shawley/.local/lib/python3.8/site-packages/torch/nn/functional.py:718: UserWarning: Named tensors and all their associated APIs are an experimental feature and subject to change. Please do not use them for anything important until they are released as stable. (Triggered internally at  /pytorch/c10/core/TensorImpl.h:1156.)
  return torch.max_pool2d(input, kernel_size, stride, padding, dilation, ceil_mode)
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>----- HALF SIZE TRAINING
Training: frozen epochs...
WandbCallback requires use of &#34;SaveModelCallback&#34; to log best model
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='0' class='' max='12' style='width:300px; height:20px; vertical-align: middle;'></progress>
      0.00% [0/12 00:00<00:00]
    </div>
    
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>mae</th>
      <th>sr_acc_old</th>
      <th>sr_acc05</th>
      <th>sr_acc1</th>
      <th>sr_acc15</th>
      <th>sr_acc2</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table><p>

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='48' class='' max='391' style='width:300px; height:20px; vertical-align: middle;'></progress>
      12.28% [48/391 00:05<00:36 14.5614]
    </div>
    
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inference">Inference<a class="anchor-link" href="#Inference"> </a></h2><p>this will generate a bunch of images of segmentation masks and a list of filenames of top losses</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fullweights</span><span class="p">)</span>

<span class="n">preds</span><span class="p">,</span> <span class="n">targs</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">with_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># validation set only</span>
<span class="nb">print</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">targs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_tmask</span><span class="p">(</span><span class="n">tmask</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># save tensor mask</span>
    <span class="n">tmask_new</span> <span class="o">=</span> <span class="n">tmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> 
    <span class="n">use_min</span><span class="p">,</span> <span class="n">use_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span>    <span class="c1"># use scale of max ring count</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span> <span class="n">use_min</span><span class="p">,</span> <span class="n">use_max</span> <span class="o">=</span> <span class="n">tmask_new</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">tmask_new</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>   <span class="c1"># auto scale for just this image</span>
    <span class="n">rescaled</span> <span class="o">=</span> <span class="p">(</span><span class="mf">255.0</span> <span class="o">/</span> <span class="n">use_max</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmask_new</span> <span class="o">-</span> <span class="n">use_min</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rescaled</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fname</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im</span>

<span class="n">seg_img_dir</span> <span class="o">=</span> <span class="s1">&#39;seg_reg_images&#39;</span>
<span class="c1">#!rm -rf {seg_img_dir};  # leave &#39;em</span>
<span class="o">!</span> mkdir <span class="o">{</span>seg_img_dir<span class="o">}</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)):</span>
    <span class="c1">#line_list = [dls.valid.items[i].stem]+[round(targs[i].cpu().numpy().item(),2), round(preds[i][0].cpu().numpy().item(),2), losses[i].cpu().numpy(), i]</span>
    <span class="n">filestem</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">line_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">filestem</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">losses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">save_tmask</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">seg_img_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">filestem</span><span class="o">+</span><span class="s1">&#39;_pred.png&#39;</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span>

<span class="c1"># store as pandas dataframe</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>

<span class="n">res_df</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># top loss order</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;segreg_top_losses_real_k</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;fastai.learner.Learner at 0x7fe9342206d0&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

